nohup: ignoring input
========================================
Transformer Quantitative Trading Strategy
========================================

[Mode] Full Experiment Run
======================================================================
基于Transformer模型的A股量化交易策略设计与效果分析
======================================================================

==================================================
[第一部分] 数据获取与清洗
==================================================
  Tushare已初始化，数据库路径: /root/eco_design/transformer_quant_strategy/stock_data.db

[1.1] 获取股票日度数据...
  正在处理 600519.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000858.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000568.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600887.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601888.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000895.SZ...
    ✓ 从数据库加载成功，共 1927 条记录
  正在处理 603288.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002304.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000661.SZ...
    ✓ 从数据库加载成功，共 1933 条记录
  正在处理 600809.SH...
    ✓ 从数据库加载成功，共 1932 条记录
  正在处理 603369.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600132.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002714.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600600.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000876.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601318.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600036.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000001.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601166.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600030.SH...
    ✓ 从数据库加载成功，共 1925 条记录
  正在处理 601688.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601398.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601939.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600016.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601601.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601628.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600837.SH...
    ✓ 从数据库加载成功，共 1701 条记录
  正在处理 601211.SH...
    ✓ 从数据库加载成功，共 1923 条记录
  正在处理 000776.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601377.SH...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 000333.SZ...
    ✓ 从数据库加载成功，共 1902 条记录
  正在处理 000651.SZ...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 002415.SZ...
    ✓ 从数据库加载成功，共 1940 条记录
  正在处理 600031.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600588.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002230.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601012.SH...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 002074.SZ...
    ✓ 从数据库加载成功，共 1935 条记录
  正在处理 002352.SZ...
    ✓ 从数据库加载成功，共 1939 条记录
  正在处理 601100.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000725.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002371.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600690.SH...
    ✓ 从数据库加载成功，共 1940 条记录
  正在处理 000100.SZ...
    ✓ 从数据库加载成功，共 1941 条记录
  正在处理 601138.SH...
    ✓ 从数据库加载成功，共 1838 条记录
  正在处理 600406.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300014.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002594.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601766.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600104.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600276.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000538.SZ...
    ✓ 从数据库加载成功，共 1891 条记录
  正在处理 601607.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 603259.SH...
    ✓ 从数据库加载成功，共 1861 条记录
  正在处理 000963.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600196.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002007.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300122.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600085.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002001.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000423.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600436.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300015.SZ...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 002603.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300347.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600900.SH...
    ✓ 从数据库加载成功，共 1931 条记录
  正在处理 600309.SH...
    ✓ 从数据库加载成功，共 1836 条记录
  正在处理 601857.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600028.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601088.SH...
    ✓ 从数据库加载成功，共 1932 条记录
  正在处理 600585.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002460.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600346.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601899.SH...
    ✓ 从数据库加载成功，共 1938 条记录
  正在处理 600547.SH...
    ✓ 从数据库加载成功，共 1941 条记录
  正在处理 002466.SZ...
    ✓ 从数据库加载成功，共 1923 条记录
  正在处理 600188.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601985.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601225.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601898.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600048.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 001979.SZ...
    ✓ 从数据库加载成功，共 1926 条记录
  正在处理 601668.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601390.SH...
    ✓ 从数据库加载成功，共 1868 条记录
  正在处理 600115.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601111.SH...
    ✓ 从数据库加载成功，共 1941 条记录
  正在处理 600029.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601006.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600009.SH...
    ✓ 从数据库加载成功，共 1931 条记录
  正在处理 601288.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600050.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600522.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000063.SZ...
    ✓ 从数据库加载成功，共 1902 条记录
  正在处理 002475.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600183.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002236.SZ...
    ✓ 从数据库加载成功，共 1940 条记录
  正在处理 300413.SZ...
    ✓ 从数据库加载成功，共 1931 条记录
  正在处理 603501.SH...
    ✓ 从数据库加载成功，共 1856 条记录
  正在处理 002049.SZ...
    ✓ 从数据库加载成功，共 1924 条记录
  正在处理 600745.SH...
    ✓ 从数据库加载成功，共 1773 条记录

  数据获取完成，总计 192995 条记录

[1.2] 数据清洗...

  数据清洗步骤（增强版）:
  [1] 缺失值数量: 100
      处理后缺失值: 0
  [3] 价格一致性检查: 修正 0 条记录
  [4] 异常值处理: 共处理 14337 个异常值
  [6] 数据类型转换完成
  [7] 数据排序完成

  清洗完成: 192995 → 192995 条记录
  数据保留率: 100.00%

[1.3] 数据描述性统计...

  数据描述性统计汇总:
  - 股票数量: 100
  - 总数据条数: 192995
  - 平均日收익率: 0.0140%
  - 收益率标准差: 2.0520%
  统计结果已保存至 output/data_statistics.csv

==================================================
[第二部分] 特征工程
==================================================

[2.1] 计算技术指标...
  计算技术指标特征...
  特征计算完成: 原始 192995 条 → 有效 192995 条
  特征数量: 81

[2.2] 特征列表:
  1. ma5
  2. ma10
  3. ma20
  4. ma60
  5. ma5_bias
  6. ma20_bias
  7. ma_trend
  8. macd_dif
  9. macd_dea
  10. macd_hist
  11. macd_cross
  12. rsi_6
  13. rsi_12
  14. rsi_24
  15. rsi_signal
  16. boll_mid
  17. boll_upper
  18. boll_lower
  19. boll_width
  20. boll_pct
  21. atr
  22. atr_pct
  23. momentum_5
  24. momentum_10
  25. momentum_20
  26. roc_10
  27. price_accel
  28. vol_ma5
  29. vol_ma20
  30. vol_ratio
  31. vol_price_corr
  32. turnover_change
  33. intraday_range
  34. close_position
  35. gap
  36. return_1d
  37. volatility_20
  38. macd_above_zero
  39. macd_golden_cross
  40. macd_death_cross
  41. macd_strong_buy
  42. macd_strong_sell
  43. macd_hist_trend
  44. macd_hist_expanding
  45. macd_hist_shrinking
  46. ma_bullish_align
  47. ma_bearish_align
  48. ma_convergence
  49. price_above_ma60
  50. big_yang
  51. big_yin
  52. doji
  53. hammer
  54. inv_hammer
  55. bullish_reversal
  56. bearish_reversal
  57. boll_break_upper
  58. boll_break_lower
  59. boll_squeeze
  60. vol_price_up
  61. vol_price_down
  62. vol_shrink
  63. extreme_volume
  64. bull_signal_strength
  65. bear_signal_strength
  66. net_signal
  67. kdj_k
  68. kdj_d
  69. kdj_j
  70. kdj_golden_cross
  71. kdj_death_cross
  72. kdj_overbought
  73. kdj_oversold
  74. dmi_plus_di
  75. dmi_minus_di
  76. dmi_adx
  77. dmi_bullish
  78. dmi_strong_trend
  79. close
  80. volume
  81. turnover_rate

  特征数据已保存至 output/feature_data.csv

==================================================
[第三部分] iTransformer模型训练与预测
==================================================
  核心创新: 在股票维度做Attention，学习多股票关联关系
    - 消费板块联动 (茅台-五粮液)
    - 金融板块协同 (平安-招行)
    - 跨板块领先滞后关系

  [缓存模式] 发现 Optuna 训练的预测缓存: output/cached_model_results.pkl
  直接加载预测结果，跳过模型训练（确保和 Optuna 结果一致）
  加载完成: 测试集 19800 条预测

[3.2] 模型评估指标:
  - MSE: 0.004442
  - MAE: 0.056057
  - 方向准确率: 44.59%

==================================================
[第四部分] 量化交易策略设计
==================================================

[4.1] 生成交易信号...
  信号生成规则:
    - 买入阈值: 预测收益率 > 2.39%
    - 卖出阈值: 预测收益率 < -0.43%
    - 止损线: 5.9%
    - 止盈线: 8.2%
    - 凯利公式: 启用

  凯利公式计算:
    - 历史胜率: 52.00%
    - 盈亏比: 1.30
    - 理论最优仓位: 15.08%
    - 实际使用仓位(半凯利): 7.54%

  信号统计:
    - 买入信号: 15705 次
    - 卖出信号: 0 次
    - 持仓不变: 4095 次

==================================================
[第五部分] 策略回测与绩效评估
==================================================

[5.1] 运行策略回测...

[5.2] 绩效指标计算...

----------------------------------------
本文策略绩效指标:
----------------------------------------
  年化收益率: 5.06%
  最大回撤: 9.93%
  夏普比率: 0.20
  胜率: 0.00%
  盈亏比: 0.00
  总交易次数: 0

[5.3] 对比策略回测...
Traceback (most recent call last):
  File "/root/eco_design/transformer_quant_strategy/main.py", line 499, in <module>
    results = main()
  File "/root/eco_design/transformer_quant_strategy/main.py", line 356, in main
    bh_results = backtest_module.buy_and_hold(feature_data)
  File "/root/eco_design/transformer_quant_strategy/backtest_engine.py", line 313, in buy_and_hold
    shares = (capital_per_stock / initial_prices / 100).astype(int) * 100
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/generic.py", line 6665, in astype
    new_data = self._mgr.astype(dtype=dtype, copy=copy, errors=errors)
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/internals/managers.py", line 449, in astype
    return self.apply(
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/internals/managers.py", line 363, in apply
    applied = getattr(b, f)(**kwargs)
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/internals/blocks.py", line 784, in astype
    new_values = astype_array_safe(values, dtype, copy=copy, errors=errors)
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/dtypes/astype.py", line 237, in astype_array_safe
    new_values = astype_array(values, dtype, copy=copy)
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/dtypes/astype.py", line 182, in astype_array
    values = _astype_nansafe(values, dtype, copy=copy)
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/dtypes/astype.py", line 101, in _astype_nansafe
    return _astype_float_to_int_nansafe(arr, dtype, copy)
  File "/root/miniconda3/envs/eco_design/lib/python3.10/site-packages/pandas/core/dtypes/astype.py", line 145, in _astype_float_to_int_nansafe
    raise IntCastingNaNError(
pandas.errors.IntCastingNaNError: Cannot convert non-finite values (NA or inf) to integer

========================================
Done! Results saved to output/
========================================
