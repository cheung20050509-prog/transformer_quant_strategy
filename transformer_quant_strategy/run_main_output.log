nohup: ignoring input
========================================
Transformer Quantitative Trading Strategy
========================================

[Mode] Full Experiment Run
======================================================================
基于Transformer模型的A股量化交易策略设计与效果分析
======================================================================

==================================================
[第一部分] 数据获取与清洗
==================================================
  Tushare已初始化，数据库路径: /root/eco_design/transformer_quant_strategy/stock_data.db

[1.1] 获取股票日度数据...
  正在处理 600519.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000858.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000568.SZ...
    ✓ 从数据库加载成功，共 2412 条记录
  正在处理 600887.SH...
    ✓ 从数据库加载成功，共 2406 条记录
  正在处理 601888.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000895.SZ...
    ✓ 从数据库加载成功，共 2415 条记录
  正在处理 603288.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002304.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000661.SZ...
    ✓ 从数据库加载成功，共 2415 条记录
  正在处理 600809.SH...
    ✓ 从数据库加载成功，共 2418 条记录
  正在处理 603369.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600132.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002714.SZ...
    ✓ 从数据库加载成功，共 2420 条记录
  正在处理 600600.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000876.SZ...
    ✓ 从数据库加载成功，共 2387 条记录
  正在处理 601318.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600036.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000001.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601166.SH...
    ✓ 从数据库加载成功，共 2425 条记录
  正在处理 600030.SH...
    ✓ 从数据库加载成功，共 2413 条记录
  正在处理 601688.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601398.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601939.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600016.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601601.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601628.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600837.SH...
    ✓ 从数据库加载成功，共 2189 条记录
  正在处理 601211.SH...
    ✓ 从数据库加载成功，共 2411 条记录
  正在处理 000776.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601377.SH...
    ✓ 从数据库加载成功，共 2415 条记录
  正在处理 000333.SZ...
    ✓ 从数据库加载成功，共 2380 条记录
  正在处理 000651.SZ...
    ✓ 从数据库加载成功，共 2273 条记录
  正在处理 002415.SZ...
    ✓ 从数据库加载成功，共 2428 条记录
  正在处理 600031.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600588.SH...
    ✓ 从数据库加载成功，共 2428 条记录
  正在处理 002230.SZ...
    ✓ 从数据库加载成功，共 2382 条记录
  正在处理 601012.SH...
    ✓ 从数据库加载成功，共 2423 条记录
  正在处理 002074.SZ...
    ✓ 从数据库加载成功，共 2407 条记录
  正在处理 002352.SZ...
    ✓ 从数据库加载成功，共 2382 条记录
  正在处理 601100.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000725.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002371.SZ...
    ✓ 从数据库加载成功，共 2420 条记录
  正在处理 600690.SH...
    ✓ 从数据库加载成功，共 2408 条记录
  正在处理 000100.SZ...
    ✓ 从数据库加载成功，共 2264 条记录
  正在处理 600406.SH...
    ✓ 从数据库加载成功，共 2321 条记录
  正在处理 300014.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002594.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601766.SH...
    ✓ 从数据库加载成功，共 2420 条记录
  正在处理 600104.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600276.SH...
    ✓ 从数据库加载成功，共 2429 条记录
  正在处理 000538.SZ...
    ✓ 从数据库加载成功，共 2266 条记录
  正在处理 601607.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 000963.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600196.SH...
    ✓ 从数据库加载成功，共 2429 条记录
  正在处理 002007.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 300122.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600085.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002001.SZ...
    ✓ 从数据库加载成功，共 2426 条记录
  正在处理 000423.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600436.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 300015.SZ...
    ✓ 从数据库加载成功，共 2414 条记录
  正在处理 002603.SZ...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 300347.SZ...
    ✓ 从数据库加载成功，共 2397 条记录
  正在处理 600900.SH...
    ✓ 从数据库加载成功，共 2413 条记录
  正在处理 600309.SH...
    ✓ 从数据库加载成功，共 2305 条记录
  正在处理 601857.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600028.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601088.SH...
    ✓ 从数据库加载成功，共 2356 条记录
  正在处理 600585.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002460.SZ...
    ✓ 从数据库加载成功，共 2427 条记录
  正在处理 600346.SH...
    ✓ 从数据库加载成功，共 2318 条记录
  正在处理 601899.SH...
    ✓ 从数据库加载成功，共 2424 条记录
  正在处理 600547.SH...
    ✓ 从数据库加载成功，共 2400 条记录
  正在处理 002466.SZ...
    ✓ 从数据库加载成功，共 2404 条记录
  正在处理 600188.SH...
    ✓ 从数据库加载成功，共 2429 条记录
  正在处理 601985.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601225.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601898.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600048.SH...
    ✓ 从数据库加载成功，共 2423 条记录
  正在处理 001979.SZ...
    ✓ 从数据库加载成功，共 2414 条记录
  正在处理 601668.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 601390.SH...
    ✓ 从数据库加载成功，共 2356 条记录
  正在处理 600115.SH...
    ✓ 从数据库加载成功，共 2429 条记录
  正在处理 601111.SH...
    ✓ 从数据库加载成功，共 2429 条记录
  正在处理 600029.SH...
    ✓ 从数据库加载成功，共 2427 条记录
  正在处理 601006.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600009.SH...
    ✓ 从数据库加载成功，共 2419 条记录
  正在处理 601288.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 600050.SH...
    ✓ 从数据库加载成功，共 2335 条记录
  正在处理 600522.SH...
    ✓ 从数据库加载成功，共 2419 条记录
  正在处理 000063.SZ...
    ✓ 从数据库加载成功，共 2359 条记录
  正在处理 002475.SZ...
    ✓ 从数据库加载成功，共 2429 条记录
  正在处理 600183.SH...
    ✓ 从数据库加载成功，共 2430 条记录
  正在处理 002236.SZ...
    ✓ 从数据库加载成功，共 2428 条记录
  正在处理 300413.SZ...
    ✓ 从数据库加载成功，共 2170 条记录
  正在处理 002049.SZ...
    ✓ 从数据库加载成功，共 2268 条记录
  正在处理 600745.SH...
    ✓ 从数据库加载成功，共 2169 条记录

  数据获取完成，总计 233033 条记录

[1.2] 数据清洗...

  数据清洗步骤（增强版）:
  [1] 缺失值数量: 97
      处理后缺失值: 0
  [3] 价格一致性检查: 修正 0 条记录
  [4] 异常值处理: 共处理 17529 个异常值
  [6] 数据类型转换完成
  [7] 数据排序完成

  清洗完成: 233033 → 233033 条记录
  数据保留率: 100.00%

[1.3] 数据描述性统计...

  数据描述性统计汇总:
  - 股票数量: 97
  - 总数据条数: 233033
  - 平均日收익率: 0.0260%
  - 收益率标准差: 1.9810%
  统计结果已保存至 output/data_statistics.csv

==================================================
[第二部分] 特征工程
==================================================

[2.1] 计算技术指标...
  计算技术指标特征...
  特征计算完成: 原始 233033 条 → 有效 233033 条
  特征数量: 81

[2.2] 特征列表:
  1. ma5
  2. ma10
  3. ma20
  4. ma60
  5. ma5_bias
  6. ma20_bias
  7. ma_trend
  8. macd_dif
  9. macd_dea
  10. macd_hist
  11. macd_cross
  12. rsi_6
  13. rsi_12
  14. rsi_24
  15. rsi_signal
  16. boll_mid
  17. boll_upper
  18. boll_lower
  19. boll_width
  20. boll_pct
  21. atr
  22. atr_pct
  23. momentum_5
  24. momentum_10
  25. momentum_20
  26. roc_10
  27. price_accel
  28. vol_ma5
  29. vol_ma20
  30. vol_ratio
  31. vol_price_corr
  32. turnover_change
  33. intraday_range
  34. close_position
  35. gap
  36. return_1d
  37. volatility_20
  38. macd_above_zero
  39. macd_golden_cross
  40. macd_death_cross
  41. macd_strong_buy
  42. macd_strong_sell
  43. macd_hist_trend
  44. macd_hist_expanding
  45. macd_hist_shrinking
  46. ma_bullish_align
  47. ma_bearish_align
  48. ma_convergence
  49. price_above_ma60
  50. big_yang
  51. big_yin
  52. doji
  53. hammer
  54. inv_hammer
  55. bullish_reversal
  56. bearish_reversal
  57. boll_break_upper
  58. boll_break_lower
  59. boll_squeeze
  60. vol_price_up
  61. vol_price_down
  62. vol_shrink
  63. extreme_volume
  64. bull_signal_strength
  65. bear_signal_strength
  66. net_signal
  67. kdj_k
  68. kdj_d
  69. kdj_j
  70. kdj_golden_cross
  71. kdj_death_cross
  72. kdj_overbought
  73. kdj_oversold
  74. dmi_plus_di
  75. dmi_minus_di
  76. dmi_adx
  77. dmi_bullish
  78. dmi_strong_trend
  79. close
  80. volume
  81. turnover_rate

  特征数据已保存至 output/feature_data.csv

==================================================
[第三部分] iTransformer模型训练与预测
==================================================
  核心创新: 在股票维度做Attention，学习多股票关联关系
    - 消费板块联动 (茅台-五粮液)
    - 金融板块协同 (平安-招行)
    - 跨板块领先滞后关系

  [缓存模式] 发现 Optuna 训练的预测缓存: output/cached_model_results.pkl
  直接加载预测结果，跳过模型训练（确保和 Optuna 结果一致）
  加载完成: 测试集 19303 条预测

[3.2] 模型评估指标:
  - MSE: 0.002416
  - MAE: 0.037495
  - 方向准确率: 55.03%

==================================================
[第四部分] 量化交易策略设计
==================================================
  [参数加载] 发现 Optuna 最优参数文件，加载策略参数...

[4.1] 生成交易信号...
  信号生成规则:
    - 买入阈值: 预测收益率 > 125.75%
    - 卖出阈值: 预测收益率 < -89.48%
    - 止损线: 2.7%
    - 止盈线: 14.0%
    - 凯利公式: 启用

  凯利公式计算:
    - 历史胜率: 52.00%
    - 盈亏比: 1.30
    - 理论最优仓位: 15.08%
    - 实际使用仓位(半凯利): 7.54%

  信号统计:
    - 买入信号: 0 次
    - 卖出信号: 0 次
    - 持仓不变: 19303 次

==================================================
[第五部分] 策略回测与绩效评估
==================================================

[5.1] 运行策略回测...

[5.2] 绩效指标计算...

----------------------------------------
本文策略绩效指标:
----------------------------------------
  年化收益率: 0.00%
  最大回撤: 0.00%
  夏普比率: -17392527.13
  胜率: 0.00%
  盈亏比: 0.00
  总交易次数: 0

[5.3] 对比策略回测...

策略对比表:
           Strategy  Annual Return(%)  Max Drawdown(%)  Sharpe Ratio  Win Rate(%)
iTransformer (Ours)          0.000000         0.000000 -1.739253e+07     0.000000
       MA Crossover         12.457215        41.304527  5.157623e-01    34.220228
         Buy & Hold         12.533860        45.421488  5.636570e-01     0.000000

==================================================
[第六部分] 结果可视化
==================================================

[6.1] 绘制累计收益曲线...
  已保存: output/equity_curves.png
[6.2] 绘制预测效果图...
  已保存: output/prediction_comparison.png
[6.3] 绘制交易信号图...
  已保存: output/trading_signals.png
[6.4] 绘制回撤曲线...
  已保存: output/drawdown.png
[6.5] 绘制模型注意力权重...
  已保存: output/attention_weights.png

==================================================
[完成] 结果已保存
==================================================
  交易记录: output/trade_log.csv
  绩效指标: output/performance_metrics.csv

所有图表已保存至 output/ 目录

======================================================================
程序运行完成！
======================================================================

========================================
Done! Results saved to output/
========================================
