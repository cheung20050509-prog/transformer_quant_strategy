nohup: ignoring input

============================================
  训练轮次 1 / 3
============================================
============================================================
  Optuna 两阶段超参数搜索
============================================================
  阶段1(模型): 20 trials
  阶段2(策略): 0 trials
  股票数量:    100
  数据库:      output/optuna_study.db
  Trial日志:   output/optuna_trial_log.csv
  设备:        cuda
============================================================
[数据准备] 获取并预处理数据（所有trial共享）
============================================================
  Tushare已初始化，数据库路径: /root/eco_design/transformer_quant_strategy/stock_data.db

[1] 获取股票数据...
  正在处理 600519.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000858.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000568.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600887.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601888.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000895.SZ...
    ✓ 从数据库加载成功，共 1927 条记录
  正在处理 603288.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002304.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000661.SZ...
    ✓ 从数据库加载成功，共 1933 条记录
  正在处理 600809.SH...
    ✓ 从数据库加载成功，共 1932 条记录
  正在处理 603369.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600132.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002714.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600600.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000876.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601318.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600036.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000001.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601166.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600030.SH...
    ✓ 从数据库加载成功，共 1925 条记录
  正在处理 601688.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601398.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601939.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600016.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601601.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601628.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600837.SH...
    ✓ 从数据库加载成功，共 1701 条记录
  正在处理 601211.SH...
    ✓ 从数据库加载成功，共 1923 条记录
  正在处理 000776.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601377.SH...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 000333.SZ...
    ✓ 从数据库加载成功，共 1902 条记录
  正在处理 000651.SZ...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 002415.SZ...
    ✓ 从数据库加载成功，共 1940 条记录
  正在处理 600031.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600588.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002230.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601012.SH...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 002074.SZ...
    ✓ 从数据库加载成功，共 1935 条记录
  正在处理 002352.SZ...
    ✓ 从数据库加载成功，共 1939 条记录
  正在处理 601100.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000725.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002371.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600690.SH...
    ✓ 从数据库加载成功，共 1940 条记录
  正在处理 000100.SZ...
    ✓ 从数据库加载成功，共 1941 条记录
  正在处理 601138.SH...
    ✓ 从数据库加载成功，共 1838 条记录
  正在处理 600406.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300014.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002594.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601766.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600104.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600276.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000538.SZ...
    ✓ 从数据库加载成功，共 1891 条记录
  正在处理 601607.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 603259.SH...
    ✓ 从数据库加载成功，共 1861 条记录
  正在处理 000963.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600196.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002007.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300122.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600085.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002001.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000423.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600436.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300015.SZ...
    ✓ 从数据库加载成功，共 1936 条记录
  正在处理 002603.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 300347.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600900.SH...
    ✓ 从数据库加载成功，共 1931 条记录
  正在处理 600309.SH...
    ✓ 从数据库加载成功，共 1836 条记录
  正在处理 601857.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600028.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601088.SH...
    ✓ 从数据库加载成功，共 1932 条记录
  正在处理 600585.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002460.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600346.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601899.SH...
    ✓ 从数据库加载成功，共 1938 条记录
  正在处理 600547.SH...
    ✓ 从数据库加载成功，共 1941 条记录
  正在处理 002466.SZ...
    ✓ 从数据库加载成功，共 1923 条记录
  正在处理 600188.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601985.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601225.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601898.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600048.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 001979.SZ...
    ✓ 从数据库加载成功，共 1926 条记录
  正在处理 601668.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601390.SH...
    ✓ 从数据库加载成功，共 1868 条记录
  正在处理 600115.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601111.SH...
    ✓ 从数据库加载成功，共 1941 条记录
  正在处理 600029.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 601006.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600009.SH...
    ✓ 从数据库加载成功，共 1931 条记录
  正在处理 601288.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600050.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600522.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 000063.SZ...
    ✓ 从数据库加载成功，共 1902 条记录
  正在处理 002475.SZ...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 600183.SH...
    ✓ 从数据库加载成功，共 1942 条记录
  正在处理 002236.SZ...
    ✓ 从数据库加载成功，共 1940 条记录
  正在处理 300413.SZ...
    ✓ 从数据库加载成功，共 1931 条记录
  正在处理 603501.SH...
    ✓ 从数据库加载成功，共 1856 条记录
  正在处理 002049.SZ...
    ✓ 从数据库加载成功，共 1924 条记录
  正在处理 600745.SH...
    ✓ 从数据库加载成功，共 1773 条记录

  数据获取完成，总计 192995 条记录

[2] 数据清洗...

  数据清洗步骤（增强版）:
  [1] 缺失值数量: 100
      处理后缺失值: 0
  [3] 价格一致性检查: 修正 0 条记录
  [4] 异常值处理: 共处理 14337 个异常值
  [6] 数据类型转换完成
  [7] 数据排序完成

  清洗完成: 192995 → 192995 条记录
  数据保留率: 100.00%

[3] 特征工程...
  计算技术指标特征...
  特征计算完成: 原始 192995 条 → 有效 192995 条
  特征数量: 81

  数据准备完成: 100只股票, 192995条, 81个特征

  [跳过阶段1] 使用已保存的最优模型参数...

============================================================
  阶段1-模型搜索(已有) 结果汇总
============================================================
  完成: 19 trials
  最佳: Trial 19 (综合得分=0.3612)
    年化收益: 7.88%
    最大回撤: 3.75%
    夏普比率: 0.6901
    胜率:     78.95%

  最佳参数:
    d_model: 1536
    d_ff_ratio: 2
    n_heads: 32
    n_layers: 14
    seq_length: 60
    dropout: 0.206562
    learning_rate: 0.000245
    batch_size: 64
    epochs: 440

  Top-5:
   Trial |       得分 |       年化收益 |       最大回撤 |       夏普
  -------------------------------------------------------
  #   19 |   0.3612 |     7.88% |     3.75% |  0.6901
  #   10 |   0.2261 |     7.80% |     6.58% |  0.4316
  #   14 |   0.0629 |     3.69% |     7.55% |  0.1338
  #    7 |  -0.0470 |     0.87% |    18.87% | -0.0238
  #    6 |  -0.1518 |     2.29% |     0.62% | -0.3148

  阶段1最优模型参数 → 阶段2:
    d_model: 1536
    d_ff: 3072
    n_heads: 32
    n_layers: 14
    seq_length: 60
    dropout: 0.206562
    learning_rate: 0.000245
    batch_size: 64
    epochs: 440

============================================================
  ===== 阶段2: 策略超参数搜索 (0 trials) =====
============================================================
  固定模型: d=1536, d_ff=3072, layers=14, epochs=440
  模式: 训练一次模型 → 复用预测结果 → 秒级策略扫描

============================================================
  [Phase2前置] 使用最优模型参数训练一次模型...
  d_model=1536, d_ff=3072, layers=14, epochs=440
============================================================
  [随机种子] 已固定 seed=42

  模型类型: iTransformer (多股票关联)
  模型参数:
    - 股票数量: 100
    - 序列长度: 60
    - 预测天数: 5
    - 模型维度: 1536
    - 注意力头数: 32
    - 编码器层数: 14
    - 训练轮数: 440
    - 学习率: 0.00024498367796095506
    - 设备: cuda

  准备全局训练数据...
  [iTransformer模式] 构建多股票同步数据...
    多股票同步日期数: 1315
    [防泄露] StandardScaler 仅在训练集(920天)上fit...
    数据划分: 训练=920天, 验证=197天, 测试=198天
  多股票训练集: (920, 100, 60, 81) (日期数, 股票数, 序列长, 特征数)
  多股票验证集: (197, 100, 60, 81)
  多股票测试集: (198, 100, 60, 81)
  全局训练集大小: 920
  全局验证集大小: 197
  全局测试集大小: 198
  使用大批量训练: Batch Size = 64

  使用iTransformer架构 (2024 ICLR): 股票间关联建模
    - 学习板块联动: 消费、金融、制造等
    - 捕捉领先滞后关系
    - 股票间Attention矩阵: 100x100
    - d_model=1536, d_ff=3072, n_layers=14, n_heads=32
  模型参数量: 269,395,527 (可训练: 269,395,527)

  开始全局模型训练...
  梯度累积步数: 8 (等效Batch Size = 512)
  早停: 基于验证集loss (patience=50)
    Epoch 10/440, Train Loss: 0.303662, Val Loss: 0.302956
    Epoch 20/440, Train Loss: 0.298023, Val Loss: 0.297598
    Epoch 30/440, Train Loss: 0.293782, Val Loss: 0.301997
    Epoch 40/440, Train Loss: 0.282693, Val Loss: 0.316720
